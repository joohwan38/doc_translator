<!DOCTYPE html>
<html lang="ko"> <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Translator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.6;
            font-size: 14px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 15px;
        }
        
        header {
            background-color: #fff;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 15px;
        }

        .header-top-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .logo {
            height: 36px;
            margin-right: 15px;
        }
        
        h1 {
            color: #2c3e50;
            font-size: 1.4em;
            text-align: center;
            flex-grow: 1;
        }

        .header-controls {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            min-width: 150px; /* Ensure minimum width for controls */
        }

        #ui-language {
            width: 130px;
            padding: 6px;
            font-size: 0.85em;
            border-radius: 4px;
        }
        
        #server-status {
            font-size: 0.8em;
            margin-top: 3px;
            text-align: right;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .panel {
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .full-width {
            grid-column: span 2;
        }
        
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .status-online { background-color: #27ae60; }
        .status-offline { background-color: #e74c3c; }
        
        .form-group {
            margin-bottom: 10px;
        }

        .language-selection-area {
            display: flex;
            justify-content: space-between;
            align-items: flex-start; /* Align labels and dropdowns to the top */
            gap: 10px;
        }

        .language-column {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .language-column label {
            margin-bottom: 4px;
            font-weight: bold;
        }

        .language-swap-column {
            display: flex;
            align-items: center;
            padding-top: calc((0.9em * 1.6) + 3px); /* Align button with select inputs */
        }

        #swap-lang-btn {
            padding: 8px 10px;
            min-width: auto;
            width: auto;
            line-height: 1;
            font-size: 1.1em;
        }
        
        label {
            display: block;
            margin-bottom: 3px;
            font-weight: bold;
            color: #555;
            font-size: 0.9em;
        }
        
        input[type="file"] {
            display: none; /* Hidden as label is used for styling */
        }

        select, button, input[type="range"], input[type="checkbox"]+label {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.9em;
        }
        input[type="checkbox"] {
            width: auto;
            margin-right: 5px;
        }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        
        button:hover {
            background-color: #0056b3;
        }
        
        button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }

        .action-button { /* Style for general action buttons, if any remain */
            background-color: #6c757d;
            font-size: 0.85em;
            padding: 6px 10px;
            width: auto;
            margin-right: 5px;
        }
        .action-button:last-child {
             margin-right: 0;
        }
        .action-button:hover {
            background-color: #5a6268;
        }
        
        .file-upload-label {
            display: block;
            padding: 10px;
            background-color: #ecf0f1;
            border: 2px dashed #bdc3c7;
            border-radius: 5px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .file-upload-label.dragover-active { /* Style for drag-over state */
            background-color: #d5dbdb;
            border-color: #95a5a6;
        }
        
        .progress-bar {
            height: 25px;
            background-color: #e9ecef;
            border-radius: 12px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #007bff;
            width: 0%;
            transition: width 0.3s ease, background-color 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .info-box {
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 0.85em;
        }
        
        .log-box {
            background-color: #212529;
            color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            height: 220px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.8em;
            line-height: 1.4;
        }
        .log-entry-error { color: #e74c3c; }
        .log-entry-success { color: #27ae60; }
        .log-entry-info { color: #f8f9fa; } /* Default log color */
        .log-entry-warning { color: #f39c12; }


        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 0.85em;
        }
        .history-table th, .history-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        .history-table th {
            background-color: #f1f3f5;
            font-weight: bold;
        }
        
        .advanced-settings {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
        }

        .advanced-options-horizontal {
            display: flex;
            gap: 15px;
        }
         .advanced-options-horizontal .form-group {
            flex: 1;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
        }
        .checkbox-group label {
            font-weight: normal;
            margin-bottom: 0;
        }
        
        .tabs {
            display: flex;
            justify-content: space-between; /* Adjusted for button removal */
            align-items: center;
            border-bottom: 2px solid #dee2e6;
            margin-bottom: 10px;
        }
        .tab-group {
            display: flex; 
        }
        .tab-buttons { /* This div is now empty, can be removed or hidden if no other buttons are planned */
            display: flex;
        }
        
        .tab {
            padding: 8px 15px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            font-size: 0.9em;
        }
        
        .tab.active {
            border-bottom-color: #007bff;
            color: #007bff;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        #stop-translation-btn {
            background-color: #dc3545;
            font-size: 0.9em;
            padding: 8px 12px;
        }
        #stop-translation-btn:hover {
            background-color: #c82333;
        }
        
        @media (max-width: 768px) {
            .main-content { grid-template-columns: 1fr; }
            .header-top-row { flex-direction: column; align-items: flex-start; }
            h1 { text-align: left; margin-top: 5px; margin-bottom: 5px; }
            .header-controls { width: 100%; flex-direction: row; justify-content: space-between; align-items: center; }
            #ui-language { width: auto; }
            .language-selection-area { flex-direction: column; gap: 5px; }
            .language-swap-column { padding-top: 5px; align-self: center; }
            .advanced-options-horizontal { flex-direction: column; gap: 0;}
            .tabs { flex-direction: column; align-items: stretch; }
            .tab-group { margin-bottom: 5px; }
            .tab-buttons { justify-content: flex-end; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-top-row">
                <img src="/static/LINEstudio2.png" alt="Logo" class="logo">
                <h1 id="app-title" data-i18n="app_title">Document Translator</h1>
                <div class="header-controls">
                    <select id="ui-language"> </select>
                    <div id="server-status">
                        <span class="status-indicator status-offline"></span>
                        <span>Ollama <span id="status-label" data-i18n="status_label">Status</span>: <span id="ollama-status" data-i18n="status_checking">Checking...</span></span>
                    </div>
                    <div id="ollama-management-area" style="font-size: 0.8em; margin-top: 5px; text-align: right;"></div>
                    <div id="model-installation-status" style="font-size: 0.8em; margin-top: 5px; text-align: right; display: none;">
                        <span id="model-install-message"></span>
                        <div id="model-install-progress-bar" style="background-color: #e0e0e0; border-radius: 3px; margin-top: 2px; display: none;">
                            <div id="model-install-progress-fill" style="width: 0%; background-color: #4caf50; height: 10px; border-radius: 3px; text-align: center; line-height: 10px; font-size: 8px; color: white;">0%</div>
        </header>
        
        <div class="main-content">
            <div class="panel">
                <h2 data-i18n="file_select_title">File Selection</h2>
                <div class="form-group">
                    <div class="file-upload">
                        <input type="file" id="file-input" accept=".pptx">
                        <label for="file-input" class="file-upload-label" data-i18n="file_upload_label">
                            Select or drag and drop a PowerPoint file here
                        </label>
                    </div>
                </div>
                <div id="file-info" class="info-box" style="display: none;">
                    <h3 data-i18n="file_info_title">File Information</h3>
                    <div class="info-item"><span data-i18n="file_name_label">Filename:</span><span id="file-name">-</span></div>
                    <div class="info-item"><span data-i18n="slide_count_label">Slides:</span><span id="slide-count">-</span></div>
                    <div class="info-item"><span data-i18n="text_count_label">Text (Chars):</span><span id="text-count">-</span></div>
                    <div class="info-item"><span data-i18n="image_count_label">Images:</span><span id="image-count">-</span></div>
                    <div class="info-item"><span data-i18n="chart_count_label">Charts:</span><span id="chart-count">-</span></div>
                </div>
            </div>
            
            <div class="panel">
                <h2 data-i18n="translation_options_title">Translation Options</h2>
                <div class="form-group language-selection-area">
                    <div class="language-column">
                        <label for="src-lang" data-i18n="source_language_label_short">Source Language</label>
                        <select id="src-lang"></select>
                    </div>
                    <div class="language-swap-column">
                        <button id="swap-lang-btn" title="Swap Languages" data-i18n-tooltip="swap_lang_button_tooltip">↔</button>
                    </div>
                    <div class="language-column">
                        <label for="tgt-lang" data-i18n="target_language_label_short">Target Language</label>
                        <select id="tgt-lang"></select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="model" data-i18n="translation_model_label">Translation Model</label>
                    <select id="model"><option value="" data-i18n="model_loading">Loading models...</option></select>
                </div>
                
                <div class="advanced-settings">
                    <h3 data-i18n="advanced_settings_title">Advanced Settings</h3>
                    <div class="advanced-options-horizontal">
                        <div class="form-group checkbox-group">
                            <input type="checkbox" id="image-translation" checked>
                            <label for="image-translation" data-i18n="image_translation_checkbox">Translate text in images (OCR)</label>
                        </div>
                        <div class="form-group checkbox-group">
                            <input type="checkbox" id="ocr-gpu">
                            <label for="ocr-gpu" data-i18n="ocr_gpu_checkbox">Use OCR GPU</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label data-i18n="ocr_temp_label">OCR Temperature (0.1 - 1.0) <span style="font-weight:normal; color: #555;" data-i18n="ocr_temp_recommended">(Recommended: 0.4)</span></label>
                        <div class="slider-group">
                            <input type="range" id="ocr-temp" class="slider" min="0.1" max="1.0" step="0.1" value="0.4">
                            <span class="slider-value" id="ocr-temp-value">0.4</span>
                        </div>
                    </div>
                </div>
                <button id="translate-btn" disabled data-i18n="start_translation_button">Start Translation</button>
            </div>
            
            <div class="panel full-width" id="progress-panel" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 data-i18n="translation_progress_title">Translation Progress</h2>
                    <button id="stop-translation-btn" style="display: none;" data-i18n="stop_translation_button">Stop Translation</button>
                </div>
                <div class="progress-bar"><div class="progress-fill" id="progress-fill">0%</div></div>
                <div id="progress-status" data-i18n="status_preparing">Preparing...</div>
                <div id="current-task" style="color: #666; font-size: 0.9em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"></div>
                <button id="download-btn" style="display: none; margin-top: 15px;" data-i18n="download_button">Download Translated File</button>
            </div>
            
            <div class="panel full-width">
                <div class="tabs">
                    <div class="tab-group">
                        <span class="tab active" data-tab="log" data-i18n="execution_log_tab">Execution Log</span>
                        <span class="tab" data-tab="history" data-i18n="translation_history_tab">Translation History</span>
                    </div>
                    <div class="tab-buttons">
                        </div>
                </div>
                
                <div id="log-tab" class="tab-content active">
                    <div class="log-box" id="log-box"><span data-i18n="app_started_log">Application started...</span></div>
                </div>
                
                <div id="history-tab" class="tab-content"> <table class="history-table">
                        <thead><tr>
                            <th data-i18n="history_col_filename">Filename</th> <th data-i18n="history_col_source">Source</th>
                            <th data-i18n="history_col_target">Target</th> <th data-i18n="history_col_model">Model</th>
                            <th data-i18n="history_col_status">Status</th> <th data-i18n="history_col_time">Time</th>
                        </tr></thead>
                        <tbody id="history-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Global variables
        let currentFileObject = null; 
        let currentServerFilePath = null; 
        let currentTranslationTaskId = null;
        let progressEventSource = null;
        let currentUILocale = 'ko'; 
        let i18nResources = {};     

        // DOM Element References
        const domElements = {
            fileInput: document.getElementById('file-input'),
            fileUploadLabel: document.getElementById('file-input').labels[0] || document.querySelector('.file-upload-label'),
            fileInfoBox: document.getElementById('file-info'),
            fileNameDisplay: document.getElementById('file-name'),
            ollamaManagementArea: document.getElementById('ollama-management-area'),
            modelInstallationStatus: document.getElementById('model-installation-status'),
            modelInstallMessage: document.getElementById('model-install-message'),
            modelInstallProgressBar: document.getElementById('model-install-progress-bar'),
            modelInstallProgressFill: document.getElementById('model-install-progress-fill'),
            slideCountDisplay: document.getElementById('slide-count'),
            textCountDisplay: document.getElementById('text-count'),
            imageCountDisplay: document.getElementById('image-count'),
            chartCountDisplay: document.getElementById('chart-count'),
            sourceLangSelect: document.getElementById('src-lang'),
            targetLangSelect: document.getElementById('tgt-lang'),
            swapLangButton: document.getElementById('swap-lang-btn'),
            modelSelect: document.getElementById('model'),
            translateButton: document.getElementById('translate-btn'),
            progressPanel: document.getElementById('progress-panel'),
            progressFill: document.getElementById('progress-fill'),
            progressStatusDisplay: document.getElementById('progress-status'),
            currentTaskDisplay: document.getElementById('current-task'),
            downloadButton: document.getElementById('download-btn'),
            logBox: document.getElementById('log-box'),
            ocrTemperatureSlider: document.getElementById('ocr-temp'),
            ocrTemperatureValueDisplay: document.getElementById('ocr-temp-value'),
            uiLanguageSelect: document.getElementById('ui-language'),
            ollamaStatusIndicator: document.querySelector('#server-status .status-indicator'),
            ollamaStatusText: document.getElementById('ollama-status'),
            ollamaStatusLabel: document.getElementById('status-label'),
            stopTranslationButton: document.getElementById('stop-translation-btn'),
            tabs: document.querySelectorAll('.tabs .tab-group .tab'),
            tabContents: document.querySelectorAll('.panel.full-width > .tab-content'),
            historyTableBody: document.getElementById('history-body'),
            appTitle: document.getElementById('app-title')
        };

        // --- Logging Function ---
        function addLog(messageOrKey, isKey = false, type = 'info', interpolateParams = null) { 
            if (!domElements.logBox) return;
            const logEntry = document.createElement('div');
            logEntry.classList.add(`log-entry-${type}`);
            
            let displayMessage = messageOrKey;
            if (isKey && i18nResources && i18nResources[messageOrKey]) {
                displayMessage = i18nResources[messageOrKey];
                if (interpolateParams) { // Simple interpolation for {param}
                    for (const key in interpolateParams) {
                        displayMessage = displayMessage.replace(`{${key}}`, interpolateParams[key]);
                    }
                }
            } else if (interpolateParams) { // Also interpolate for non-key messages if params provided
                 for (const key in interpolateParams) {
                    displayMessage = displayMessage.replace(`{${key}}`, interpolateParams[key]);
                }
            }


            const timestamp = new Date().toLocaleTimeString();
            logEntry.textContent = `[${timestamp}] ${displayMessage}`;
            
            domElements.logBox.appendChild(logEntry);
            domElements.logBox.scrollTop = domElements.logBox.scrollHeight;
        }
        
        // Helper function to add the default/empty model option
        function addDefaultNoModelsOption(customTextKey = 'no_models_found') { // Takes a key now
            if (domElements.modelSelect) {
                domElements.modelSelect.innerHTML = ''; 
                const option = document.createElement('option');
                option.value = "";
                option.textContent = (i18nResources && i18nResources[customTextKey]) || customTextKey; // Fallback to key itself
                domElements.modelSelect.appendChild(option);
                domElements.modelSelect.value = ""; 
            }
        }

        // --- Localization and UI Update Functions ---
        async function loadAndSetLanguageResources(langCode) {
            console.log(`[Localization] Attempting to load: ${langCode}`);
            try {
                const response = await fetch(`/api/ui_languages?lang=${langCode}`);
                if (!response.ok) {
                    const errorText = await response.text().catch(() => `HTTP ${response.status}`);
                    console.error(`[Localization] Failed to load language file: ${response.status}`, errorText);
                    throw new Error(`Failed to load language file: ${response.status}`);
                }
                const data = await response.json();
                i18nResources = data.resources || {};
                currentUILocale = data.current_language || langCode;
                localStorage.setItem('uiLanguagePDT', currentUILocale); 
                document.documentElement.lang = currentUILocale.split('-')[0]; 
                console.log(`[Localization] Current language: ${currentUILocale}`);
                applyLocalization();
            } catch (error) {
                console.error('[Localization] Exception during language resource loading:', error);
                i18nResources = {}; 
                applyLocalization(); 
            }
        }
        
        function applyLocalization() {
            console.log("[Localization] Applying localization...");
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                const fallbackText = element.textContent || element.title || (element.placeholder || ''); 
                let localizedText = (i18nResources && i18nResources[key]) || fallbackText;
                
                if (element.placeholder && (i18nResources && i18nResources[key])) {
                     element.placeholder = localizedText;
                } else if (element.title && (i18nResources && i18nResources[key]) && !element.hasAttribute('data-i18n-tooltip')) { 
                    // Apply to title only if not specifically a tooltip key
                    element.title = localizedText;
                }
                // For elements that should have their textContent updated
                else if ((element.tagName === 'BUTTON' || element.tagName === 'SPAN' || element.tagName === 'LABEL' || 
                           element.tagName === 'H1' || element.tagName === 'H2' || element.tagName === 'H3' || 
                           element.tagName === 'TH' || (element.tagName === 'OPTION' && element.value === "")) &&
                           (i18nResources && i18nResources[key])) {
                     element.textContent = localizedText;
                } else if (element.tagName !== 'INPUT' && element.tagName !== 'SELECT' && (i18nResources && i18nResources[key])) {
                     element.textContent = localizedText;
                }
            });
             // Apply to elements targeted by data-i18n-tooltip for titles
            document.querySelectorAll('[data-i18n-tooltip]').forEach(element => {
                const key = element.getAttribute('data-i18n-tooltip');
                if (i18nResources && i18nResources[key]) {
                    element.title = i18nResources[key];
                }
            });


            if(domElements.appTitle) domElements.appTitle.textContent = (i18nResources && i18nResources.app_title) || 'Document Translator';
            // swapLangButton title is handled by data-i18n-tooltip now
            
            updateTranslationLanguageOptions(); 
            updateOllamaStatusDisplay(); 
            updateTranslateButtonState(); 
            // Update initial log box text
            if (domElements.logBox && domElements.logBox.children.length === 1 && domElements.logBox.children[0].tagName === 'SPAN' && domElements.logBox.children[0].hasAttribute('data-i18n')) {
                const key = domElements.logBox.children[0].getAttribute('data-i18n');
                if (i18nResources && i18nResources[key]) {
                    domElements.logBox.children[0].textContent = i18nResources[key];
                }
            }


            console.log("[Localization] Localization applied.");
        }

        function updateOllamaStatusDisplay(statusData = null) {
            if(!domElements.ollamaStatusText || !domElements.ollamaStatusLabel) return;
            domElements.ollamaStatusLabel.textContent = (i18nResources && i18nResources.status_label) || 'Status';

            if (statusData) {
                const portText = (i18nResources && i18nResources.ollama_port_label) || 'Port';
                 if (statusData.running) domElements.ollamaStatusText.textContent = `${(i18nResources && i18nResources.ollama_running) || 'Running'} (${portText}: ${statusData.port})`;
                 else if (statusData.installed) domElements.ollamaStatusText.textContent = (i18nResources && i18nResources.ollama_installed_not_running) || 'Installed (not running)';
                 else domElements.ollamaStatusText.textContent = (i18nResources && i18nResources.ollama_not_installed) || 'Not installed';
            } else {
                 domElements.ollamaStatusText.textContent = (i18nResources && i18nResources.status_checking) || 'Checking...';
            }
        }
        
        function updateTranslationLanguageOptions() {
            console.log("[Localization] Updating translation language options...");
            const langOptionsMap = { 
                "ko": "translation_lang_ko", "en": "translation_lang_en", "ja": "translation_lang_ja",
                "zh-CN": "translation_lang_zh_CN", "zh-TW": "translation_lang_zh_TW",
                "th": "translation_lang_th", "es": "translation_lang_es"
            };

            [domElements.sourceLangSelect, domElements.targetLangSelect].forEach(selectElement => {
                if (!selectElement) {
                    console.warn("Language select dropdown not found for update.");
                    return;
                }
                const currentSelectedValue = selectElement.value;
                selectElement.innerHTML = ''; 
                Object.keys(langOptionsMap).forEach(langCode => {
                    const option = document.createElement('option');
                    option.value = langCode;
                    option.textContent = (i18nResources && i18nResources[langOptionsMap[langCode]]) || langCode; 
                    selectElement.appendChild(option);
                });

                if (currentSelectedValue && Array.from(selectElement.options).some(opt => opt.value === currentSelectedValue)) {
                    selectElement.value = currentSelectedValue;
                } else if (selectElement.options.length > 0) {
                    if (selectElement.id === 'src-lang') {
                        selectElement.value = (currentUILocale === 'ko' || currentUILocale === 'ja') ? currentUILocale : 'en';
                    } else if (selectElement.id === 'tgt-lang') {
                        selectElement.value = (currentUILocale === 'ko') ? 'en' : 'ko';
                    }
                }
            });
            console.log("[Localization] Translation language options updated.");
        }
        
        // --- Core Application Logic ---
        let isModelInstallationInProgress = false; // 모델 설치 진행 중 상태 플래그
        let defaultOllamaModel = "gemma3:12b"; // 기본값, 추후 API에서 받아오도록 변경 가능

        async function checkOllamaStatus() {
            if (isModelInstallationInProgress) {
                console.log("Model installation in progress, skipping Ollama status check.");
                return;
            }
            console.log("Checking Ollama status...");
            domElements.ollamaManagementArea.innerHTML = ''; // 이전 관리 컨트롤 초기화
            domElements.modelInstallationStatus.style.display = 'none';

            try {
                const response = await fetch('/api/check_ollama'); // 이 API는 default_model_name도 반환하도록 수정 가능
                if (!response.ok) {
                    // ... (기존 오류 처리) ...
                    const errorText = await response.text().catch(() => `HTTP ${response.status}`);
                    if (domElements.ollamaStatusIndicator) domElements.ollamaStatusIndicator.classList.add('status-offline');
                    const apiErrorMsgKey = 'ollama_status_error_api_generic';
                    if (domElements.ollamaStatusText) domElements.ollamaStatusText.textContent = ((i18nResources && i18nResources[apiErrorMsgKey]) || 'API Error: ') + response.status;
                    throw new Error(`Ollama API response error: ${errorText}`);
                }
                const data = await response.json();
                console.log("Ollama status data received:", data);
                // 백엔드에서 기본 모델명을 전달받도록 할 수 있음
                // defaultOllamaModel = data.default_ollama_model || "gemma3:12b";


                updateOllamaStatusDisplay(data); // Ollama 상태 (설치됨, 실행중 등) UI 업데이트
                if (domElements.ollamaStatusIndicator) {
                    domElements.ollamaStatusIndicator.classList.toggle('status-online', data.running);
                    domElements.ollamaStatusIndicator.classList.toggle('status-offline', !data.running);
                }

                if (!data.installed) {
                    // 1. Ollama 미설치 시
                    const notInstalledMsg = (i18nResources && i18nResources.ollama_not_installed_prompt) || 'Ollama is not installed. Please download and install it from the official website.';
                    const downloadLink = `<a href="https://ollama.com/download" target="_blank">${(i18nResources && i18nResources.ollama_download_link_text) || 'Download Ollama'}</a>`;
                    domElements.ollamaManagementArea.innerHTML = `<p>${notInstalledMsg} ${downloadLink}</p>`;
                    addDefaultNoModelsOption('ollama_not_installed_no_models'); // 모델 목록도 업데이트
                } else if (!data.running) {
                    // 2. Ollama 비활성화 시 (설치는 되어 있음)
                    const notRunningMsg = (i18nResources && i18nResources.ollama_not_running_prompt) || 'Ollama is installed but not running.';
                    const startButton = document.createElement('button');
                    startButton.textContent = (i18nResources && i18nResources.ollama_start_button) || 'Start Ollama';
                    startButton.onclick = async () => {
                        startButton.disabled = true;
                        startButton.textContent = (i18nResources && i18nResources.ollama_starting_button) || 'Starting...';
                        addLog('log_ollama_attempt_start', true, 'info');
                        try {
                            const startResponse = await fetch('/api/start_ollama', { method: 'POST' });
                            const startData = await startResponse.json();
                            if (startData.success) {
                                addLog('log_ollama_start_success', true, 'success');
                                setTimeout(checkOllamaStatus, 3000); // 잠시 후 상태 다시 확인
                            } else {
                                addLog('log_ollama_start_failed', true, 'error');
                                startButton.disabled = false;
                                startButton.textContent = (i18nResources && i18nResources.ollama_start_button) || 'Start Ollama';
                            }
                        } catch (e) {
                            addLog('log_ollama_start_exception', true, 'error', { message: e.message });
                            startButton.disabled = false;
                            startButton.textContent = (i18nResources && i18nResources.ollama_start_button) || 'Start Ollama';
                        }
                    };
                    domElements.ollamaManagementArea.innerHTML = `<p>${notRunningMsg} </p>`;
                    domElements.ollamaManagementArea.appendChild(startButton);
                    addDefaultNoModelsOption('ollama_not_running_no_models');
                } else {
                    // Ollama 설치 및 실행 중 -> 모델 목록 처리
                    populateModelDropdown(data.models); // 아래 정의된 함수 사용

                    // 3. Ollama 모델 부재 시 기본 모델 자동 설치
                    if (!data.models || data.models.length === 0 || !data.models.includes(defaultOllamaModel)) {
                        const modelToInstall = defaultOllamaModel;
                        domElements.modelInstallMessage.textContent = ((i18nResources && i18nResources.status_default_model_missing_install_prompt) || `Default model '${modelToInstall}' is not found. Attempting to install...`).replace('{modelName}', modelToInstall);
                        domElements.modelInstallationStatus.style.display = 'block';
                        domElements.modelInstallProgressBar.style.display = 'block'; // Show progress bar div
                        domElements.modelInstallProgressFill.style.width = '0%';
                        domElements.modelInstallProgressFill.textContent = '0%';
                        isModelInstallationInProgress = true;
                        pullOllamaModel(modelToInstall);
                    }
                }

            } catch (error) {
                // ... (기존 예외 처리) ...
                console.error("Exception during Ollama status check:", error);
                if (domElements.ollamaStatusIndicator) domElements.ollamaStatusIndicator.classList.add('status-offline');
                if (domElements.ollamaStatusText) domElements.ollamaStatusText.textContent = (i18nResources && i18nResources.ollama_status_exception) || 'Error checking status';
                if (domElements.modelSelect) addDefaultNoModelsOption('model_load_error');
            }
            updateTranslateButtonState();
        }

        async function pullOllamaModel(modelName) {
            addLog('log_model_pull_starting', true, 'info', { modelName: modelName });
            isModelInstallationInProgress = true; // Set flag
            domElements.modelInstallMessage.textContent = ((i18nResources && i18nResources.status_model_pulling) || "Downloading model {modelName}...").replace('{modelName}', modelName);
            domElements.modelInstallProgressBar.style.display = 'block';
            domElements.modelInstallProgressFill.style.width = '0%';
            domElements.modelInstallProgressFill.textContent = '0%';

            try {
                // 1. Start the pull process on the backend
                const pullResponse = await fetch('/api/pull_model', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model_name: modelName })
                });
                const pullData = await pullResponse.json();

                if (!pullResponse.ok || !pullData.success) {
                    throw new Error(pullData.error || ((i18nResources && i18nResources.error_model_pull_start_failed) || 'Failed to start model download.'));
                }

                // 2. Listen for progress updates using SSE
                if (modelPullEventSource) {
                    modelPullEventSource.close();
                }
                modelPullEventSource = new EventSource(`/api/model_pull_progress/${encodeURIComponent(modelName)}`);

                modelPullEventSource.onmessage = function(event) {
                    const progressData = JSON.parse(event.data);
                    console.log("Model pull progress:", progressData);
                    domElements.modelInstallMessage.textContent = progressData.status;

                    if (progressData.total > 0 && progressData.completed >= 0) {
                        const percentage = Math.round((progressData.completed / progressData.total) * 100);
                        domElements.modelInstallProgressFill.style.width = `${percentage}%`;
                        domElements.modelInstallProgressFill.textContent = `${percentage}%`;
                    } else if (progressData.status.toLowerCase().includes("downloading") || progressData.status.toLowerCase().includes("pulling")) {
                        // Indeterminate progress if total is not available yet
                        domElements.modelInstallProgressFill.style.width = '100%'; // Or a looping animation
                        domElements.modelInstallProgressFill.textContent = ''; // No percentage
                    }


                    if (progressData.error) {
                        addLog('log_model_pull_error', true, 'error', { modelName: modelName, details: progressData.status });
                        modelPullEventSource.close();
                        isModelInstallationInProgress = false;
                        domElements.modelInstallationStatus.style.display = 'none';
                        checkOllamaStatus(); // Refresh status
                    } else if (progressData.done) {
                        addLog('log_model_pull_success', true, 'success', { modelName: modelName });
                        modelPullEventSource.close();
                        isModelInstallationInProgress = false;
                        domElements.modelInstallationStatus.style.display = 'none';
                        checkOllamaStatus(); // Refresh status and model list
                    }
                };

                modelPullEventSource.onerror = function(err) {
                    console.error("Model pull EventSource failed:", err);
                    addLog('log_model_pull_error_connection', true, 'error', { modelName: modelName });
                    modelPullEventSource.close();
                    isModelInstallationInProgress = false;
                    domElements.modelInstallationStatus.style.display = 'none';
                    checkOllamaStatus(); // Refresh status
                };

            } catch (error) {
                console.error("Error initiating model pull:", error);
                addLog('log_model_pull_init_failed', true, 'error', { modelName: modelName, message: error.message });
                isModelInstallationInProgress = false;
                domElements.modelInstallationStatus.style.display = 'none';
                checkOllamaStatus(); // Refresh status
            }
        }

        function populateModelDropdown(modelsArray) {
            if (domElements.modelSelect) {
                const currentModelVal = domElements.modelSelect.value;
                domElements.modelSelect.innerHTML = '';

                if (modelsArray && Array.isArray(modelsArray) && modelsArray.length > 0) {
                    console.log(`[ModelPopulation] Populating with ${modelsArray.length} models:`, modelsArray);
                    let validModelsFound = 0;
                    modelsArray.forEach(modelName => {
                        if (typeof modelName === 'string' && modelName.trim() !== '') {
                            const option = document.createElement('option');
                            option.value = modelName;
                            option.textContent = modelName;
                            domElements.modelSelect.appendChild(option);
                            validModelsFound++;
                        }
                    });

                    if (validModelsFound > 0) {
                        const firstValidModel = domElements.modelSelect.options[0].value;
                        if (currentModelVal && modelsArray.includes(currentModelVal)) {
                            domElements.modelSelect.value = currentModelVal;
                        } else {
                            domElements.modelSelect.value = firstValidModel;
                        }
                        console.log(`[ModelPopulation] Model selection set to: ${domElements.modelSelect.value}`);
                    } else {
                         addDefaultNoModelsOption('no_models_found');
                    }
                } else {
                    addDefaultNoModelsOption('no_models_found');
                }
            } else {
                console.error("[ModelPopulation] CRITICAL: domElements.modelSelect not found!");
            }
        }


        let modelPullEventSource = null;

        
        function updateTranslateButtonState() {
            const fileReady = currentServerFilePath && currentFileObject;
            const sourceLangSelected = domElements.sourceLangSelect && domElements.sourceLangSelect.value;
            const targetLangSelected = domElements.targetLangSelect && domElements.targetLangSelect.value;
            const modelSelected = domElements.modelSelect && domElements.modelSelect.value;

            if (domElements.translateButton) {
                domElements.translateButton.disabled = !(fileReady && sourceLangSelected && targetLangSelected && modelSelected);
            }
        }

        async function handleFileSelect(file) {
            if (!file) return;

            if (!file.name.toLowerCase().endsWith('.pptx')) {
                addLog('error_invalid_file_type_pptx', true, 'error');
                resetFileInput();
                return;
            }

            currentFileObject = file;
            if (domElements.fileNameDisplay) domElements.fileNameDisplay.textContent = file.name;
            if (domElements.fileUploadLabel) domElements.fileUploadLabel.textContent = file.name; 

            addLog('file_analyzing', true, 'info');
            if (domElements.fileInfoBox) domElements.fileInfoBox.style.display = 'none';
            if (domElements.translateButton) domElements.translateButton.disabled = true;

            const formData = new FormData();
            formData.append('file', currentFileObject);

            try {
                const response = await fetch('/api/file_info', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (response.ok && data.filepath) {
                    currentServerFilePath = data.filepath;
                    if (domElements.fileNameDisplay) domElements.fileNameDisplay.textContent = data.filename || currentFileObject.name;
                    if (domElements.slideCountDisplay) domElements.slideCountDisplay.textContent = data.info.slide_count ?? '-';
                    if (domElements.textCountDisplay) domElements.textCountDisplay.textContent = `${data.info.text_elements_count ?? '-'} (${data.info.total_text_char_count ?? '-'})`;
                    if (domElements.imageCountDisplay) domElements.imageCountDisplay.textContent = data.info.image_elements_count ?? '-';
                    if (domElements.chartCountDisplay) domElements.chartCountDisplay.textContent = data.info.chart_elements_count ?? '-';
                    if (domElements.fileInfoBox) domElements.fileInfoBox.style.display = 'block';
                    addLog('file_analysis_complete', true, 'success');
                } else {
                    throw new Error(data.error || ((i18nResources && i18nResources.error_file_analysis_failed) || 'File analysis failed'));
                }
            } catch (error) {
                console.error("File processing error:", error);
                addLog('error_file_processing', true, 'error', { message: error.message });
                resetFileInput();
            }
            updateTranslateButtonState();
        }

        function resetFileInput() {
            currentFileObject = null;
            currentServerFilePath = null;
            if (domElements.fileInput) domElements.fileInput.value = ''; 
            if (domElements.fileUploadLabel) domElements.fileUploadLabel.textContent = (i18nResources && i18nResources.file_upload_label) || 'Select or drag and drop a PowerPoint file here';
            if (domElements.fileInfoBox) domElements.fileInfoBox.style.display = 'none';
            if (domElements.fileNameDisplay) domElements.fileNameDisplay.textContent = '-';
            if (domElements.slideCountDisplay) domElements.slideCountDisplay.textContent = '-';
            if (domElements.textCountDisplay) domElements.textCountDisplay.textContent = '-';
            if (domElements.imageCountDisplay) domElements.imageCountDisplay.textContent = '-';
            if (domElements.chartCountDisplay) domElements.chartCountDisplay.textContent = '-';
            updateTranslateButtonState();
        }
        
        function startProgressMonitoring(taskId) {
            console.log(`[Progress] Monitoring started for task ID: ${taskId}`);
            if (progressEventSource) {
                progressEventSource.close();
            }
            progressEventSource = new EventSource(`/api/progress/${taskId}`);

            progressEventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                if (domElements.progressFill) {
                    domElements.progressFill.style.width = `${data.progress}%`;
                    domElements.progressFill.textContent = `${data.progress}%`;
                }
                if (domElements.progressStatusDisplay) domElements.progressStatusDisplay.textContent = data.status; // Should be localized from backend
                if (domElements.currentTaskDisplay) domElements.currentTaskDisplay.textContent = data.current_task || "";

                if (data.completed) {
                    progressEventSource.close();
                    if (domElements.stopTranslationButton) domElements.stopTranslationButton.style.display = 'none';
                    if (data.download_url && !data.error) {
                        if (domElements.downloadButton) {
                            domElements.downloadButton.onclick = () => window.location.href = data.download_url;
                            domElements.downloadButton.style.display = 'block';
                        }
                        addLog("translation_completed_download", true, "success");
                    } else if (data.error) {
                        addLog('log_translation_error_generic', true, "error", { error: data.error });
                    } else {
                         addLog("translation_completed_no_download", true, "info");
                    }
                }
            };
            progressEventSource.onerror = function(err) {
                console.error("EventSource failed:", err);
                addLog('error_progress_connection', true, "error");
                progressEventSource.close();
                if (domElements.stopTranslationButton) domElements.stopTranslationButton.style.display = 'none';
            };
        }
        
        async function loadHistory() {
            if(!domElements.historyTableBody) {
                console.error("History table body not found.");
                addLog('error_history_area_not_found', true, 'error');
                return;
            }
            try {
                console.log("Requesting history data...");
                const response = await fetch('/api/history');
                if (!response.ok) {
                    const errorText = await response.text().catch(() => `HTTP ${response.status}`);
                    addLog('error_history_load_status', true, 'error', { status: errorText });
                    console.error("History API request failed:", response.status, errorText);
                    return; 
                }
                const historyData = await response.json();
                console.log("History data received:", historyData);
                
                domElements.historyTableBody.innerHTML = ''; 
                if (Array.isArray(historyData)) { 
                    historyData.slice(0, 20).forEach(item => { 
                        if (typeof item === 'object' && item !== null) { 
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td>${item.name || '-'}</td> <td>${item.src || '-'}</td>
                                <td>${item.tgt || '-'}</td> <td>${item.model || '-'}</td>
                                <td>${item.status || '-'}</td> <td>${item.time || '-'}</td>
                            `;
                            domElements.historyTableBody.appendChild(tr);
                        } else { 
                            console.warn("Invalid history item format:", item);
                        }
                    });
                } else { 
                    console.warn("History data is not an array:", historyData);
                    addLog('warning_history_invalid_format', true, 'warning');
                }
            } catch (error) { 
                console.error("Exception loading history:", error);
                addLog('error_history_load_exception', true, 'error', { message: error.message });
            }
        }

        // --- Event Listeners Setup ---
        function setupEventListeners() {
            if(domElements.uiLanguageSelect) {
                domElements.uiLanguageSelect.addEventListener('change', (e) => {
                    console.log('[Event] UI language changed to:', e.target.value);
                    loadAndSetLanguageResources(e.target.value);
                });
            }

            if(domElements.swapLangButton && domElements.sourceLangSelect && domElements.targetLangSelect) {
                domElements.swapLangButton.addEventListener('click', () => {
                    console.log('[Event] Swap languages button clicked.');
                    const sourceVal = domElements.sourceLangSelect.value;
                    const targetVal = domElements.targetLangSelect.value;
                    domElements.sourceLangSelect.value = targetVal;
                    domElements.targetLangSelect.value = sourceVal;
                    updateTranslateButtonState(); 
                });
            }
            
            if (domElements.fileInput) {
                domElements.fileInput.addEventListener('change', (e) => handleFileSelect(e.target.files[0]));
            }

            if (domElements.fileUploadLabel && domElements.fileInput) {
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    domElements.fileUploadLabel.addEventListener(eventName, preventDefaults, false);
                    document.body.addEventListener(eventName, preventDefaults, false); 
                });

                function preventDefaults(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }

                ['dragenter', 'dragover'].forEach(eventName => {
                    domElements.fileUploadLabel.addEventListener(eventName, () => {
                        domElements.fileUploadLabel.classList.add('dragover-active');
                        domElements.fileUploadLabel.textContent = (i18nResources && i18nResources.file_drop_prompt) || 'Drop the file here';
                    }, false);
                });

                domElements.fileUploadLabel.addEventListener('dragleave', () => {
                    domElements.fileUploadLabel.classList.remove('dragover-active');
                    const originalLabelKey = 'file_upload_label';
                    domElements.fileUploadLabel.textContent = currentFileObject ? currentFileObject.name : ((i18nResources && i18nResources[originalLabelKey]) || 'Select or drag and drop a PowerPoint file here');
                }, false);

                domElements.fileUploadLabel.addEventListener('drop', async (e) => {
                    domElements.fileUploadLabel.classList.remove('dragover-active');
                    const droppedFiles = e.dataTransfer.files;
                    if (droppedFiles.length > 0) {
                        handleFileSelect(droppedFiles[0]); 
                    } else {
                        const originalLabelKey = 'file_upload_label';
                        domElements.fileUploadLabel.textContent = (i18nResources && i18nResources[originalLabelKey]) || 'Select or drag and drop a PowerPoint file here';
                    }
                }, false);
            }

            [domElements.sourceLangSelect, domElements.targetLangSelect, domElements.modelSelect].forEach(selectElement => {
                if (selectElement) selectElement.addEventListener('change', updateTranslateButtonState);
            });
            
            if(domElements.ocrTemperatureSlider && domElements.ocrTemperatureValueDisplay) {
                domElements.ocrTemperatureSlider.addEventListener('input', (e) => {
                    domElements.ocrTemperatureValueDisplay.textContent = e.target.value;
                });
            }
            
            if(domElements.translateButton) {
                domElements.translateButton.addEventListener('click', async () => {
                    if (!currentServerFilePath || !currentFileObject) {
                        addLog('error_no_file_for_translation', true, 'error');
                        return;
                    }
                    console.log('[Event] Translate button clicked.');
                    domElements.translateButton.disabled = true;
                    if(domElements.progressPanel) domElements.progressPanel.style.display = 'block';
                    if(domElements.progressFill) {
                         domElements.progressFill.style.width = '0%';
                         domElements.progressFill.textContent = '0%';
                    }
                    if(domElements.progressStatusDisplay) domElements.progressStatusDisplay.textContent = (i18nResources && i18nResources.status_translation_starting) || "Translation starting...";
                    if(domElements.downloadButton) domElements.downloadButton.style.display = 'none';
                    if(domElements.stopTranslationButton) domElements.stopTranslationButton.style.display = 'block';

                    const payload = {
                        filepath: currentServerFilePath,
                        src_lang: domElements.sourceLangSelect.value,
                        tgt_lang: domElements.targetLangSelect.value,
                        model: domElements.modelSelect.value,
                        image_translation: document.getElementById('image-translation').checked,
                        ocr_temperature: parseFloat(domElements.ocrTemperatureSlider.value),
                        ocr_use_gpu: document.getElementById('ocr-gpu').checked,
                        ui_language: currentUILocale
                    };

                    try {
                        const response = await fetch('/api/translate', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        const data = await response.json();
                        if (response.ok && data.task_id) {
                            currentTranslationTaskId = data.task_id;
                            addLog('log_translation_task_started_id', true, 'info', { taskId: currentTranslationTaskId });
                            startProgressMonitoring(currentTranslationTaskId);
                        } else {
                             throw new Error(data.error || ((i18nResources && i18nResources.error_translation_start_failed) || "Failed to start translation task"));
                        }
                    } catch (error) {
                        console.error("Error starting translation:", error);
                        addLog('error_starting_translation_exception', true, 'error', { message: error.message });
                        if(domElements.translateButton) domElements.translateButton.disabled = false; 
                        if(domElements.progressPanel) domElements.progressPanel.style.display = 'none';
                        if(domElements.stopTranslationButton) domElements.stopTranslationButton.style.display = 'none';
                    }
                });
            }
            
            if(domElements.tabs && domElements.tabContents) {
                domElements.tabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        const tabName = tab.dataset.tab;
                        console.log('[Event] Tab clicked:', tabName);
                        
                        domElements.tabs.forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        
                        domElements.tabContents.forEach(content => content.classList.remove('active'));

                        const activeContent = document.getElementById(`${tabName}-tab`);
                        if (activeContent) {
                            activeContent.classList.add('active');
                            console.log(`Tab content ${activeContent.id} activated.`);
                        } else {
                            console.error(`Tab content with ID '${tabName}-tab' not found.`);
                        }
                        
                        if (tabName === 'history') {
                            console.log('History tab activated, loading history...');
                            loadHistory();
                        }
                    });
                });
            } else {
                console.error("Tabs or tab contents not found; tab switching logic cannot be set up.");
            }

            if(domElements.stopTranslationButton) {
                domElements.stopTranslationButton.addEventListener('click', async () => {
                    if (currentTranslationTaskId) {
                        console.log(`[Event] Stop translation button clicked for task: ${currentTranslationTaskId}`);
                        addLog('translation_stopping_task', true, 'info', { taskId: currentTranslationTaskId });
                        try {
                            const response = await fetch(`/api/stop_translation/${currentTranslationTaskId}`, { method: 'POST' });
                            const data = await response.json();
                            if (response.ok) {
                                addLog('log_translation_stop_signal_sent', true, 'success');
                            } else {
                                throw new Error(data.error || ((i18nResources && i18nResources.error_sending_stop_signal) || "Failed to send stop signal"));
                            }
                        } catch (error) {
                            console.error("Error stopping translation:", error);
                            addLog('error_stopping_translation_exception', true, 'error', { message: error.message });
                        }
                    } else {
                        addLog('warning_no_active_task_to_stop', true, 'warning');
                    }
                });
            }
        }
        
        // --- Initialization ---
        window.addEventListener('load', async () => {
            console.log("Page loaded, starting initialization.");
            const uiLanguageOptions = { "ko": "한국어", "en": "English", "ja": "日本語", "zh-CN": "简体中文", "zh-TW": "繁體中文", "th": "ไทย" };
            if(domElements.uiLanguageSelect) {
                Object.entries(uiLanguageOptions).forEach(([code, name]) => {
                    const option = document.createElement('option');
                    option.value = code;
                    option.textContent = name; // This will be overwritten by applyLocalization if a key exists
                    domElements.uiLanguageSelect.appendChild(option);
                });
                const savedLanguage = localStorage.getItem('uiLanguagePDT') || 'ko'; 
                domElements.uiLanguageSelect.value = savedLanguage;
                await loadAndSetLanguageResources(savedLanguage); 
            } else { 
                console.warn("UI language select dropdown not found. Defaulting to 'ko'.");
                await loadAndSetLanguageResources('ko'); 
            }
            
            setupEventListeners(); 
            
            checkOllamaStatus(); 
            loadHistory();       
            resetFileInput();    
            updateTranslateButtonState();

            console.log("Initialization complete.");
        });
    </script>
</body>
</html>