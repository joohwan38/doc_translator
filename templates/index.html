<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Translator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.6;
            font-size: 14px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 15px;
        }
        
        header {
            background-color: #fff;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 15px;
        }

        .header-top-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .logo {
            height: 36px;
            margin-right: 15px;
        }
        
        h1 {
            color: #2c3e50;
            font-size: 1.4em;
            text-align: center;
            flex-grow: 1;
        }

        .header-controls {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            min-width: 150px; /* 컨트롤 영역 최소 너비 확보 */
        }

        #ui-language {
            width: 130px;
            padding: 6px;
            font-size: 0.85em;
            border-radius: 4px;
        }
        
        #server-status {
            font-size: 0.8em;
            margin-top: 3px;
            text-align: right;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .panel {
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .full-width {
            grid-column: span 2;
        }
        
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .status-online { background-color: #27ae60; }
        .status-offline { background-color: #e74c3c; }
        
        .form-group {
            margin-bottom: 10px;
        }

        .language-selection-area {
            display: flex;
            justify-content: space-between;
            align-items: flex-start; /* 레이블과 드롭다운 상단 정렬 */
            gap: 10px;
        }

        .language-column {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .language-column label {
            margin-bottom: 4px;
            font-weight: bold;
        }

        .language-swap-column {
            display: flex;
            align-items: center; 
            /* 레이블이 있는 select의 높이에 맞춰 버튼이 중앙에 오도록 padding-top 조정 */
            /* label font-size 0.9em + margin-bottom 3px ~= 12.6px + 3px. padding: 8px */
            /* 대략 (12.6px + 3px + 8px(select padding)) / 2  */
            padding-top: calc((0.9em * 1.6) + 3px); /* label 높이 + margin 만큼 위에서 밀어줌 */
        }

        #swap-lang-btn {
            padding: 8px 10px;
            min-width: auto;
            width: auto;
            line-height: 1;
            font-size: 1.1em;
        }
        
        label {
            display: block;
            margin-bottom: 3px;
            font-weight: bold;
            color: #555;
            font-size: 0.9em;
        }
        
        /* input[type="file"] 스타일은 label로 대체하므로 숨김 */
        input[type="file"] {
            display: none;
        }

        select, button, input[type="range"], input[type="checkbox"]+label {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.9em;
        }
        input[type="checkbox"] {
            width: auto;
            margin-right: 5px;
        }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        
        button:hover {
            background-color: #0056b3;
        }
        
        button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }

        .action-button {
            background-color: #6c757d;
            font-size: 0.85em;
            padding: 6px 10px;
            width: auto;
            margin-right: 5px;
        }
        .action-button:last-child {
             margin-right: 0;
        }
        .action-button:hover {
            background-color: #5a6268;
        }
        
        .file-upload-label {
            display: block;
            padding: 10px;
            background-color: #ecf0f1;
            border: 2px dashed #bdc3c7;
            border-radius: 5px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .file-upload-label:hover {
            background-color: #d5dbdb;
            border-color: #95a5a6;
        }
        
        .progress-bar {
            height: 25px;
            background-color: #e9ecef;
            border-radius: 12px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #007bff;
            width: 0%;
            transition: width 0.3s ease, background-color 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .info-box {
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 0.85em;
        }
        
        .log-box {
            background-color: #212529;
            color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            height: 220px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.8em;
            line-height: 1.4;
        }
        
        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 0.85em;
        }
        .history-table th, .history-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        .history-table th {
            background-color: #f1f3f5;
            font-weight: bold;
        }
        
        .advanced-settings {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
        }

        .advanced-options-horizontal {
            display: flex;
            gap: 15px;
        }
         .advanced-options-horizontal .form-group {
            flex: 1;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
        }
        .checkbox-group label {
            font-weight: normal;
            margin-bottom: 0;
        }
        
        .tabs {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #dee2e6;
            margin-bottom: 10px;
        }
        .tab-group {
            display: flex; 
        }
        .tab-buttons {
            display: flex;
        }
        
        .tab {
            padding: 8px 15px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            font-size: 0.9em;
        }
        
        .tab.active {
            border-bottom-color: #007bff;
            color: #007bff;
            font-weight: bold;
        }
        
        /* 탭 컨텐츠 기본 숨김 및 활성 시 보임 */
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        #stop-translation-btn {
            background-color: #dc3545;
            font-size: 0.9em;
            padding: 8px 12px;
        }
        #stop-translation-btn:hover {
            background-color: #c82333;
        }
        
        @media (max-width: 768px) {
            .main-content { grid-template-columns: 1fr; }
            .header-top-row { flex-direction: column; align-items: flex-start; }
            h1 { text-align: left; margin-top: 5px; margin-bottom: 5px; }
            .header-controls { width: 100%; flex-direction: row; justify-content: space-between; align-items: center; }
            #ui-language { width: auto; }
            .language-selection-area { flex-direction: column; gap: 5px; }
            .language-swap-column { padding-top: 5px; align-self: center; }
            .advanced-options-horizontal { flex-direction: column; gap: 0;}
            .tabs { flex-direction: column; align-items: stretch; }
            .tab-group { margin-bottom: 5px; }
            .tab-buttons { justify-content: flex-end; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-top-row">
                <img src="/static/LINEstudio2.png" alt="Logo" class="logo">
                <h1 id="app-title">Document Translator</h1>
                <div class="header-controls">
                    <select id="ui-language"> </select>
                    <div id="server-status">
                        <span class="status-indicator status-offline"></span>
                        <span>Ollama <span id="status-label" data-i18n="status_label">상태</span>: <span id="ollama-status" data-i18n="status_checking">확인 중...</span></span>
                    </div>
                </div>
            </div>
        </header>
        
        <div class="main-content">
            <div class="panel">
                <h2 data-i18n="file_select_title">파일 선택</h2>
                <div class="form-group">
                    <div class="file-upload">
                        <input type="file" id="file-input" accept=".pptx">
                        <label for="file-input" class="file-upload-label" data-i18n="file_upload_label">
                            PowerPoint 파일을 선택하거나 여기에 드래그하세요
                        </label>
                    </div>
                </div>
                <div id="file-info" class="info-box" style="display: none;">
                    <h3 data-i18n="file_info_title">파일 정보</h3>
                    <div class="info-item"><span data-i18n="file_name_label">파일명:</span><span id="file-name">-</span></div>
                    <div class="info-item"><span data-i18n="slide_count_label">슬라이드:</span><span id="slide-count">-</span></div>
                    <div class="info-item"><span data-i18n="text_count_label">텍스트(자):</span><span id="text-count">-</span></div>
                    <div class="info-item"><span data-i18n="image_count_label">이미지:</span><span id="image-count">-</span></div>
                    <div class="info-item"><span data-i18n="chart_count_label">차트:</span><span id="chart-count">-</span></div>
                </div>
            </div>
            
            <div class="panel">
                <h2 data-i18n="translation_options_title">번역 옵션</h2>
                <div class="form-group language-selection-area">
                    <div class="language-column">
                        <label for="src-lang" data-i18n="source_language_label_short">원본 언어</label>
                        <select id="src-lang"></select>
                    </div>
                    <div class="language-swap-column">
                        <button id="swap-lang-btn" title="언어 교체">↔</button>
                    </div>
                    <div class="language-column">
                        <label for="tgt-lang" data-i18n="target_language_label_short">대상 언어</label>
                        <select id="tgt-lang"></select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="model" data-i18n="translation_model_label">번역 모델</label>
                    <select id="model"><option value="" data-i18n="model_loading">모델 로딩 중...</option></select>
                </div>
                
                <div class="advanced-settings">
                    <h3 data-i18n="advanced_settings_title">고급 설정</h3>
                    <div class="advanced-options-horizontal">
                        <div class="form-group checkbox-group">
                            <input type="checkbox" id="image-translation" checked>
                            <label for="image-translation" data-i18n="image_translation_checkbox">이미지 내 텍스트 번역 (OCR)</label>
                        </div>
                        <div class="form-group checkbox-group">
                            <input type="checkbox" id="ocr-gpu">
                            <label for="ocr-gpu" data-i18n="ocr_gpu_checkbox">OCR GPU 사용</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label data-i18n="ocr_temp_label">OCR 온도 (0.1 - 1.0) <span style="font-weight:normal; color: #555;" data-i18n="ocr_temp_recommended">(권장: 0.4)</span></label>
                        <div class="slider-group">
                            <input type="range" id="ocr-temp" class="slider" min="0.1" max="1.0" step="0.1" value="0.4">
                            <span class="slider-value" id="ocr-temp-value">0.4</span>
                        </div>
                    </div>
                </div>
                <button id="translate-btn" disabled data-i18n="start_translation_button">번역 시작</button>
            </div>
            
            <div class="panel full-width" id="progress-panel" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 data-i18n="translation_progress_title">번역 진행률</h2>
                    <button id="stop-translation-btn" style="display: none;" data-i18n="stop_translation_button">번역 중지</button>
                </div>
                <div class="progress-bar"><div class="progress-fill" id="progress-fill">0%</div></div>
                <div id="progress-status" data-i18n="status_preparing">준비 중...</div>
                <div id="current-task" style="color: #666; font-size: 0.9em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"></div>
                <button id="download-btn" style="display: none; margin-top: 15px;" data-i18n="download_button">번역된 파일 다운로드</button>
            </div>
            
            <div class="panel full-width">
                <div class="tabs">
                    <div class="tab-group"> 
                        <span class="tab active" data-tab="log" data-i18n="execution_log_tab">실행 로그</span>
                        <span class="tab" data-tab="history" data-i18n="translation_history_tab">번역 이력</span>
                    </div>
                    <div class="tab-buttons"> 
                        <button id="open-log-folder-btn" class="action-button" data-i18n="open_log_folder_button">로그 폴더</button>
                        <button id="delete-history-btn" class="action-button" data-i18n="delete_history_button">이력 삭제</button>
                    </div>
                </div>
                
                <div id="log-tab" class="tab-content active">
                    <div class="log-box" id="log-box"><span data-i18n="app_started_log">앱이 시작되었습니다...</span></div>
                </div>
                
                <div id="history-tab" class="tab-content"> <table class="history-table">
                        <thead><tr>
                            <th data-i18n="history_col_filename">파일명</th> <th data-i18n="history_col_source">원본</th>
                            <th data-i18n="history_col_target">대상</th> <th data-i18n="history_col_model">모델</th>
                            <th data-i18n="history_col_status">상태</th> <th data-i18n="history_col_time">시간</th>
                        </tr></thead>
                        <tbody id="history-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // 전역 변수
        let currentFile = null;
        let currentFilePath = null;
        let currentTaskId = null;
        let eventSource = null;
        let currentUILanguage = 'ko';
        let i18nResources = {};
        
        // DOM 요소 그룹
        const 요소 = {
            fileInput: document.getElementById('file-input'),
            fileLabel: document.querySelector('.file-upload-label'),
            fileInfoBox: document.getElementById('file-info'),
            fileName: document.getElementById('file-name'),
            slideCount: document.getElementById('slide-count'),
            textCount: document.getElementById('text-count'),
            imageCount: document.getElementById('image-count'),
            chartCount: document.getElementById('chart-count'),
            srcLangSelect: document.getElementById('src-lang'),
            tgtLangSelect: document.getElementById('tgt-lang'),
            swapLangBtn: document.getElementById('swap-lang-btn'),
            modelSelect: document.getElementById('model'),
            translateBtn: document.getElementById('translate-btn'),
            progressPanel: document.getElementById('progress-panel'),
            progressFill: document.getElementById('progress-fill'),
            progressStatus: document.getElementById('progress-status'),
            currentTaskDisplay: document.getElementById('current-task'),
            downloadBtn: document.getElementById('download-btn'),
            logBox: document.getElementById('log-box'),
            ocrTempSlider: document.getElementById('ocr-temp'),
            ocrTempValue: document.getElementById('ocr-temp-value'),
            uiLanguageSelect: document.getElementById('ui-language'),
            ollamaStatusIndicator: document.querySelector('#server-status .status-indicator'),
            ollamaStatusText: document.getElementById('ollama-status'),
            ollamaStatusLabel: document.getElementById('status-label'),
            openLogFolderBtn: document.getElementById('open-log-folder-btn'),
            deleteHistoryBtn: document.getElementById('delete-history-btn'),
            stopTranslationBtn: document.getElementById('stop-translation-btn'),
            tabs: document.querySelectorAll('.tabs .tab-group .tab'), // 더 정확한 선택자
            tabContents: document.querySelectorAll('.panel.full-width > .tab-content'), // 탭 패널 바로 아래 컨텐츠
            historyBody: document.getElementById('history-body'),
            appTitle: document.getElementById('app-title')
        };

        // --- 다국어 및 UI 업데이트 함수들 ---
        async function loadAndSetLanguageResources(langCode) {
            console.log(`[ linguistique ] 로드 시도: ${langCode}`);
            try {
                const response = await fetch(`/api/ui_languages?lang=${langCode}`);
                if (!response.ok) {
                    console.error(`[ linguistique ] 언어 파일 로드 실패: ${response.status}`, await response.text().catch(()=>""));
                    throw new Error(`언어 파일 로드 실패: ${response.status}`);
                }
                const data = await response.json();
                i18nResources = data.resources || {};
                currentUILanguage = data.current_language || langCode;
                localStorage.setItem('uiLanguagePDT', currentUILanguage);
                document.documentElement.lang = currentUILanguage.split('-')[0];
                console.log(`[ linguistique ] 현재 언어: ${currentUILanguage}, 리소스:`, i18nResources);
                applyLocalization();
            } catch (error) {
                console.error('[ linguistique ] 언어 리소스 로드 중 예외:', error);
                i18nResources = {}; 
                applyLocalization(); // 오류 시에도 기본값으로 UI 업데이트 시도
            }
        }
        
        function applyLocalization() {
            console.log("[ linguistique ] 현지화 적용 시작");
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                const fallbackText = element.textContent; 
                const localizedText = i18nResources[key] || fallbackText;
                
                if (element.tagName === 'INPUT' && element.placeholder && i18nResources[key]) element.placeholder = localizedText;
                else if ((element.tagName === 'BUTTON' || element.tagName === 'SPAN' || element.tagName === 'LABEL' || element.tagName === 'H1' || element.tagName === 'H2' || element.tagName === 'H3' || element.tagName === 'TH' || (element.tagName === 'OPTION' && element.value === "")) && i18nResources[key]) {
                     element.textContent = localizedText;
                } else if (element.title && key.endsWith("_tooltip") && i18nResources[key]) {
                    element.title = localizedText;
                } else if (i18nResources[key]) {
                    element.innerHTML = localizedText; // 주의: innerHTML은 XSS에 취약할 수 있으나, 여기서는 내부 리소스 사용 가정
                }
            });
            if(요소.appTitle) 요소.appTitle.textContent = i18nResources.app_title || 'Document Translator';
            if(요소.swapLangBtn) 요소.swapLangBtn.title = i18nResources.swap_lang_button_tooltip || '언어 교체';

            updateTranslationLanguageOptions(); // 번역 언어 드롭다운 채우기
            updateOllamaStatusText(); // Ollama 상태 텍스트 업데이트
            console.log("[ linguistique ] 현지화 적용 완료");
        }

        function updateOllamaStatusText(statusData = null) {
            if(!요소.ollamaStatusText || !요소.ollamaStatusLabel) return;
            요소.ollamaStatusLabel.textContent = i18nResources.status_label || '상태';

            if (statusData) {
                 if (statusData.running) 요소.ollamaStatusText.textContent = `${i18nResources.ollama_running || '실행 중'} (${i18nResources.ollama_port_label || '포트'}: ${statusData.port})`;
                 else if (statusData.installed) 요소.ollamaStatusText.textContent = i18nResources.ollama_installed_not_running || '설치됨 (실행되지 않음)';
                 else 요소.ollamaStatusText.textContent = i18nResources.ollama_not_installed || '설치되지 않음';
            } else {
                 요소.ollamaStatusText.textContent = i18nResources.status_checking || '확인 중...';
            }
        }
        
        function updateTranslationLanguageOptions() {
            console.log("[ linguistique ] 번역 언어 옵션 업데이트 중...");
            const langOptionsMap = {
                "ko": "translation_lang_ko", "en": "translation_lang_en", "ja": "translation_lang_ja",
                "zh-CN": "translation_lang_zh_CN", "zh-TW": "translation_lang_zh_TW",
                "th": "translation_lang_th", "es": "translation_lang_es"
            };
            [요소.srcLangSelect, 요소.tgtLangSelect].forEach(select => {
                if (!select) {
                    console.warn("언어 선택 드롭다운을 찾을 수 없습니다:", select === 요소.srcLangSelect ? "srcLangSelect" : "tgtLangSelect");
                    return;
                }
                const currentValue = select.value;
                select.innerHTML = ''; // 이전 옵션 제거
                Object.keys(langOptionsMap).forEach(code => {
                    const option = document.createElement('option');
                    option.value = code;
                    option.textContent = i18nResources[langOptionsMap[code]] || code; // 다국어 이름, 없으면 코드
                    select.appendChild(option);
                });
                // 이전 값 복원 또는 기본값 설정
                if (currentValue && Array.from(select.options).some(opt => opt.value === currentValue)) {
                    select.value = currentValue;
                } else if (select.options.length > 0) {
                    if (select.id === 'src-lang') select.value = (currentUILanguage === 'ko' || currentUILanguage === 'ja') ? currentUILanguage : 'en';
                    else if (select.id === 'tgt-lang') select.value = (currentUILanguage === 'ko') ? 'en' : 'ko';
                }
            });
            console.log("[ linguistique ] 번역 언어 옵션 업데이트 완료.");
        }
        
        // --- 이벤트 리스너들 ---
        if(요소.uiLanguageSelect) 요소.uiLanguageSelect.addEventListener('change', (e) => {
            console.log('[ 이벤트 ] UI 언어 변경됨:', e.target.value);
            loadAndSetLanguageResources(e.target.value);
        });

        if(요소.swapLangBtn && 요소.srcLangSelect && 요소.tgtLangSelect) {
            요소.swapLangBtn.addEventListener('click', () => {
                console.log('[ 이벤트 ] 언어 교환 버튼 클릭됨');
                const srcVal = 요소.srcLangSelect.value;
                const tgtVal = 요소.tgtLangSelect.value;
                요소.srcLangSelect.value = tgtVal;
                요소.tgtLangSelect.value = srcVal;
                updateTranslateButtonState(); 
            });
        }
        
        function addLog(message, isKey = false, type = 'info') { /* ... 이전과 동일 ... */ }
        
        async function checkOllamaStatus() {
            console.log("Ollama 상태 확인 시작...");
            try {
                const response = await fetch('/api/check_ollama');
                if (!response.ok) { 
                    const errorText = await response.text().catch(() => `HTTP ${response.status}`);
                    throw new Error(`Ollama API 응답 오류: ${errorText}`);
                }
                const data = await response.json();
                console.log("Ollama 상태 데이터:", data);
                
                updateOllamaStatusText(data);
                
                if (요소.ollamaStatusIndicator) {
                    if (data.running) {
                        요소.ollamaStatusIndicator.classList.remove('status-offline');
                        요소.ollamaStatusIndicator.classList.add('status-online');
                    } else {
                        요소.ollamaStatusIndicator.classList.remove('status-online');
                        요소.ollamaStatusIndicator.classList.add('status-offline');
                        if (data.installed) { /* ... 실행 유도 ... */ } 
                        else { /* ... 설치 안내 ... */ }
                    }
                }

                if(요소.modelSelect) { /* ... 모델 목록 채우기, 이전과 동일 ... */ }

            } catch (error) { /* ... 오류 처리, 이전과 동일 ... */ }
            updateTranslateButtonState();
        }

        async function startOllama() { /* ... 이전과 동일 ... */ }
        if(요소.fileInput) 요소.fileInput.addEventListener('change', async (e) => { /* ... 이전과 동일 ... */ });
        if(요소.fileLabel) { /* ... 드래그앤드롭 이전과 동일 ... */ }
        function updateTranslateButtonState() { /* ... 이전과 동일 ... */ }
        [요소.srcLangSelect, 요소.tgtLangSelect, 요소.modelSelect].forEach(el => { /* ... 이전과 동일 ... */ });
        if(요소.ocrTempSlider && 요소.ocrTempValue) 요소.ocrTempSlider.addEventListener('input', (e) => 요소.ocrTempValue.textContent = e.target.value);
        if(요소.translateBtn) 요소.translateBtn.addEventListener('click', async () => { /* ... 이전과 동일 ... */ });
        function startProgressMonitoring(taskId) { /* ... 이전과 동일 ... */ }
        
        // 탭 전환 로직
        if(요소.tabs && 요소.tabContents) {
            요소.tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.dataset.tab;
                    console.log('[ 이벤트 ] 탭 클릭됨:', tabName);
                    
                    요소.tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    요소.tabContents.forEach(content => {
                        // console.log(`탭 컨텐츠 ${content.id} 활성 클래스 제거 시도`);
                        content.classList.remove('active');
                    });

                    const activeContent = document.getElementById(`${tabName}-tab`);
                    if (activeContent) {
                        activeContent.classList.add('active');
                        console.log(`탭 컨텐츠 ${activeContent.id} 활성화됨`);
                    } else {
                        console.error(`ID가 '${tabName}-tab'인 탭 컨텐츠를 찾을 수 없습니다.`);
                    }
                    
                    if (tabName === 'history') {
                        console.log('번역 이력 탭 활성화, 이력 로드 중...');
                        loadHistory();
                    }
                });
            });
        } else {
            console.error("탭 또는 탭 컨텐츠 요소를 찾을 수 없어 탭 전환 로직을 설정할 수 없습니다.");
        }

        async function loadHistory() {
            if(!요소.historyBody) {
                console.error("이력 테이블 body(historyBody)를 찾을 수 없습니다.");
                addLog("이력 표시 영역을 찾을 수 없습니다.", false, 'error');
                return;
            }
            try {
                console.log("이력 데이터 요청 중...");
                const response = await fetch('/api/history');
                if (!response.ok) {
                    const errorText = await response.text().catch(() => `HTTP ${response.status}`);
                    addLog(`${i18nResources.error_history_load_status || '이력 로드 실패, 상태'}: ${errorText}`, false, 'error');
                    console.error("이력 API 요청 실패:", response.status, errorText);
                    return; 
                }
                const history = await response.json();
                console.log("이력 데이터 수신:", history);
                
                요소.historyBody.innerHTML = ''; 
                if (Array.isArray(history)) { 
                    history.slice(0, 20).forEach(item => {
                        if (typeof item === 'object' && item !== null) { 
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td>${item.name || '-'}</td> <td>${item.src || '-'}</td>
                                <td>${item.tgt || '-'}</td> <td>${item.model || '-'}</td>
                                <td>${item.status || '-'}</td> <td>${item.time || '-'}</td>
                            `;
                            요소.historyBody.appendChild(tr);
                        } else { /* ... 오류 처리 ... */ }
                    });
                } else { /* ... 오류 처리 ... */ }
            } catch (error) { /* ... 오류 처리 ... */ }
        }

        // 새 버튼 이벤트 리스너
        if(요소.openLogFolderBtn) 요소.openLogFolderBtn.addEventListener('click', async () => { /* ... 이전과 동일 (콘솔 로그 추가된 버전) ... */ });
        if(요소.deleteHistoryBtn) 요소.deleteHistoryBtn.addEventListener('click', async () => { /* ... 이전과 동일 (콘솔 로그 추가된 버전) ... */ });
        if(요소.stopTranslationBtn) 요소.stopTranslationBtn.addEventListener('click', async () => { /* ... 이전과 동일 ... */ });
        
        // 초기화
        window.addEventListener('load', async () => {
            console.log("페이지 로드 완료, 초기화 시작.");
            const uiLangOptions = { "ko": "한국어", "en": "English", "ja": "日本語", "zh-CN": "简体中文", "zh-TW": "繁體中文", "th": "ไทย" };
            if(요소.uiLanguageSelect) {
                Object.entries(uiLangOptions).forEach(([code, name]) => {
                    const option = document.createElement('option');
                    option.value = code;
                    option.textContent = name;
                    요소.uiLanguageSelect.appendChild(option);
                });
                const savedLanguage = localStorage.getItem('uiLanguagePDT') || 'ko';
                요소.uiLanguageSelect.value = savedLanguage;
                await loadAndSetLanguageResources(savedLanguage); // await 추가
            } else { 
                console.warn("UI 언어 선택 드롭다운을 찾을 수 없습니다.");
                await loadAndSetLanguageResources('ko'); // 기본 한국어로 시도
            }
            
            // DOM 요소들이 확실히 로드된 후 실행
            checkOllamaStatus();
            loadHistory(); // 초기 히스토리 로드
            console.log("초기화 완료.");
        });
    </script>
</body>
</html>